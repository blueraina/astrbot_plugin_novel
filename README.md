# 📖 群体协作长篇小说 AstrBot 插件 v2.4

> ⚠️ **免责声明**：本插件代码主要由 AI 生成，可能存在未知的 bug 或逻辑问题。请在生产环境中使用时保持谨慎，建议先在测试群进行充分测试。

QQ群群友协作 + AI辅助写作的长篇小说插件。群友提供创意和设定，AI 负责评审、生成和润色。还可自动收集群聊消息生成小说！

## ✨ 核心功能

| 功能模块 | 说明 |
|---------|------|
| 🌍 知识库 | JSON 存储世界观、人物、多风格模板，AI 自动整理完善世界观 |
| 💡 创意系统 | 群友提交创意 → 多AI打分(×3轮) → 冲突检测 → 投票决策 |
| ✍️ 场景写作 | 以"场景"为最小单元，基于知识库+风格参考生成（默认4000+字），自动维护摘要 |
| ✏️ 多AI修正 | 三轮流水线：审读→修改→审校，逐步提升文本质量 |
| 🧑 人物管理 | 添加/修改/删除角色，同名重复自动拦截，AI 写作时自动提取新角色 |
| 🔧 用户介入修正 | 用户可描述修改意见或进入交互收集模式，AI 根据反馈修正章节 |
| 📊 投票系统 | 冲突自动发起投票，群友参与投票决定方案 |
| 🔒 群隔离 | 每个群独立一部小说，数据互不干扰 |
| 🤖 分角色AI模型 | WebUI 下拉选择，可为创意评分/写作/修正/世界观分别指定AI模型 |
| 👥 贡献者追踪 | 自动记录参与创作的群友昵称，导出时显示在封面 |
| 📚 多格式导出 | 支持 TXT / EPUB / PDF，导出后自动发送文件到群聊 |
| 🗣️ **群聊小说** | **新！**自动收集群聊消息，AI 以群友为原型生成小说，每群独立 |

### v2.4 新增特性

- **🗣️ 群聊小说增强**：
  - 新增指令：`/群聊小说 修改名称 <新书名>`、`/群聊小说 删除`
  - 优化构建指令：`/群聊小说 开始构建 <书名> <要求>`
  - 导出优化：PDF/EPUB 简介页将风格要求与剧情分开展示，修复作者名过长换行问题
  - 配置项：`chat_novel_threshold` 可自定义触发章节生成的阈值

### v2.3 特性

- **🗣️ 群聊小说**：全新功能，自动收集群聊消息并生成小说
  - 发送 `/群聊小说 开始构建 <书名> <要求>` 开始收集
  - AI 以群友为人物原型，根据聊天内容自动创作小说章节
  - 每累计 50 条消息自动生成一章（可配置）
  - 完整的人物管理、阅读、导出支持
  - 与现有 `/小说` 功能完全独立

### v2.2 特性

- **✏️ 修改人物命令**：`/小说 修改人物 <名字> <新描述>` 随时修改角色设定
- **🚫 人物防重复**：添加角色时自动检测同名角色，已存在则提示使用修改命令
- **📝 AI 长篇写作**：场景默认字数提升至 4000 字，prompt 增强要求丰富的环境描写、心理活动和感官细节
- **🤖 AI 自动收录人物**：AI 写作时自动识别新角色并添加到人物库（含详细描述和背景），同名角色自动合并不重复
- **🔧 描述录入修复**：修复了添加人物时描述文本被框架截断未能保存的问题

### v2.1 特性

- **🤖 分角色AI模型配置**：在 WebUI 中通过下拉框为创意评分、写作生成、修正审校、世界观整理分别配置不同的AI模型
- **👥 贡献者追踪**：自动记录参与创作群友的QQ昵称，PDF/EPUB 封面显示 "作者: xxx, xxx"
- **🔧 用户介入修正**：`/小说 更改 <章节号> <描述>` 一次性提交修改意见，或 `/小说 更改 <章节号> 开始` 进入交互收集模式
- **🗑️ 删除指令**：`/小说 删除人物`、`/小说 删除设定`、`/小说 清空世界观`
- **📤 文件自动发送**：导出 TXT/EPUB/PDF 后自动将文件发送到群聊
- **📄 MikTeX PDF**：PDF 导出优先使用 xelatex 获得更好的排版质量，不可用时自动回退到 fpdf2

---

## 📦 安装

### 1. 复制插件

将整个文件夹放到 AstrBot 插件目录：
```
AstrBot/data/plugins/astrbot_plugin_novel/
```

### 2. 安装依赖

```bash
pip install ebooklib fpdf2
```

> `ebooklib` 用于 EPUB 导出，`fpdf2` 用于 PDF 导出（当 xelatex 不可用时）。如果不需要这两种格式，可以不安装（TXT 导出不需要额外依赖）。

### 3. 启用插件

在 AstrBot WebUI 中启用 **群体协作长篇小说** 插件，然后重载。

---

## ⚙️ 配置项

在 WebUI 的插件配置页面调整：

### 基础配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `enabled_groups` | list | `[]` | **允许使用本插件的群号列表**。留空=所有群都可用 |
| `score_threshold` | int | 70 | 创意通过的最低加权平均分（0-100） |
| `ai_score_rounds` | int | 3 | AI 打分轮数（模拟多AI评审） |
| `vote_duration_minutes` | int | 30 | 冲突投票持续时间（分钟） |
| `max_scene_length` | int | 4000 | 单个场景的最小生成字数（AI 会尽量写更多） |
| `debug` | bool | false | 开启调试日志 |
| `allow_private_commands` | bool | false | 允许在私聊中使用指令 |
| `chat_novel_threshold` | int | 50 | 群聊小说：每累计多少条消息自动生成一章 |

### AI 模型配置

每个功能角色可在 WebUI 中通过**下拉框**选择已配好的模型商。留空则使用全局默认模型。

| 配置项 | 说明 | 对应功能 |
|--------|------|----------|
| `provider_idea_scoring` | 创意评分 AI | 创意提交打分 |
| `provider_writing` | 写作生成 AI | 场景写作 |
| `provider_revision` | 修正审校 AI | 场景/章节修正 |
| `provider_worldview` | 世界观整理 AI | 世界观自动/手动整理 |

> 💡 建议：写作和修正使用较强的模型（如 GPT-4 / Claude），创意评分和世界观整理可使用性价比更高的模型。

### 群白名单配置示例

只允许群号 `123456789` 和 `987654321` 使用：
```json
{
  "enabled_groups": ["123456789", "987654321"]
}
```

留空则所有群都可使用：
```json
{
  "enabled_groups": []
}
```

---

## 📁 数据结构

```text
AstrBot/data/plugin_data/astrbot_plugin_novel/
└── groups/
    ├── 123456789/                    ← 群 123456789 的数据
    │   ├── knowledge/
    │   │   ├── worldview.json
    │   │   ├── worldview_backup.json ← AI 整理前的备份
    │   │   ├── characters.json
    │   │   └── styles/
    │   │       └── 硬科幻.json
    │   ├── novel.json               ← 含 contributors 贡献者列表
    │   ├── ideas.json
    │   ├── votes.json
    │   └── exports/                  ← 导出文件
    │       ├── 星辰之海.txt
    │       ├── 星辰之海.epub
    │       └── 星辰之海.pdf
    │   ├── chat_novel.json          ← 群聊小说数据（状态、章节、人物）
    │   └── chat_messages.json       ← 群聊消息缓冲区
    └── 987654321/                    ← 群 987654321 的数据（完全独立）
        ├── knowledge/ ...
        └── novel.json ...
```

---

## 🎮 指令一览

所有指令以 `/小说` 开头（也可用 `/novel`）。

> 💡 v2.2 新增：`/小说 修改人物`、人物防重复、AI 自动收录人物。

### 基础指令

| 指令 | 说明 |
|------|------|
| `/小说 帮助` | 显示所有可用指令 |
| `/小说 初始化 <标题>` | 创建一部新小说 |
| `/小说 状态` | 查看当前小说的进度、字数、概要 |
| `/小说 重置` | ⚠️ 清空当前群的所有数据，重新开始 |

### 知识库指令

| 指令 | 说明 |
|------|------|
| `/小说 世界观` | 查看当前世界观 |
| `/小说 设定 <内容>` | 添加/修改世界观 |
| `/小说 整理世界观` | 手动触发 AI 整理完善世界观 |
| `/小说 删除设定 <字段> <关键词>` | 删除世界观中的某条设定 |
| `/小说 清空世界观` | 清空整个世界观 |
| `/小说 添加人物 <名字> <描述>` | 添加一个新角色（同名自动拦截） |
| `/小说 修改人物 <名字> <内容>` | **✨新** 修改角色设定 |
| `/小说 删除人物 <名字>` | 删除角色 |
| `/小说 人物列表` | 查看所有角色 |
| `/小说 人物 <名字>` | 查看某个角色的详情 |

### 风格指令

| 指令 | 说明 |
|------|------|
| `/小说 风格列表` | 查看所有可用风格 |
| `/小说 添加风格 <名称>` | 创建新风格，之后发送示例文本自动收集 |
| `/小说 风格样本 <名称> <文本>` | 手动为某风格追加一段示例文本 |
| `/小说 切换风格 <名称>` | 切换当前写作使用的风格 |
| `/小说 完成风格` | 结束风格样本收集 |

### 创意指令

| 指令 | 说明 |
|------|------|
| `/小说 创意 <内容>` | 提交一个创意（自动打分+冲突检测） |
| `/小说 创意列表` | 查看所有已采纳的创意 |

### 写作指令

| 指令 | 说明 |
|------|------|
| `/小说 新章节 <标题>` | 创建新章节 |
| `/小说 写 <场景描述>` | AI 根据描述生成一个新场景 |
| `/小说 修正` | 对最新场景进行三轮 AI 修正润色 |
| `/小说 大纲` | 查看当前小说的章节和场景大纲 |
| `/小说 更改 <章节号> <描述>` | 一次性提交修改意见，AI 修正指定章节 |
| `/小说 更改 <章节号> 开始` | 进入交互修正模式，逐条收集修改意见 |
| `/小说 结束更改` | 结束交互修正，将收集的意见提交 AI 修改 |

### 投票指令

| 指令 | 说明 |
|------|------|
| `/小说 投票` | 查看当前进行中的投票 |
| `/小说 投票 <选项>` | 投票（A/B/C） |
| `/小说 结束投票` | 手动关闭当前投票 |

### 导出指令

| 指令 | 说明 |
|------|------|
| `/小说 导出` | 导出全文为 TXT 并发送到群聊 |
| `/小说 导出 epub` | 导出为 EPUB 电子书并发送到群聊 |
| `/小说 导出 pdf` | 导出为 PDF 并发送到群聊 |
| `/小说 阅读 [章节号]` | 阅读指定章节（不填读最新） |

---

### 🗣️ 群聊小说指令

与 `/小说` 完全独立的新功能，基于群聊消息自动生成小说。

| 指令 | 说明 |
|------|------|
| `/群聊小说 帮助` | 显示群聊小说指令 |
| `/群聊小说 开始构建 <书名> <要求>` | 开始收集群聊消息并构建小说 |
| `/群聊小说 停止` | 停止收集 |
| `/群聊小说 继续` | 继续收集（从停止状态恢复，不清空数据） |
| `/群聊小说 状态` | 查看进度（章节数、消息数、字数等） |
| `/群聊小说 修改名称 <新书名>` | 修改小说名称 |
| `/群聊小说 删除` | 删除本群所有小说数据 |
| `/群聊小说 人物列表` | 查看所有角色（原型群友 → 小说角色） |
| `/群聊小说 人物 <名字>` | 查看角色详情 |
| `/群聊小说 阅读 [章节号]` | 阅读指定章节（不填读最新） |
| `/群聊小说 导出 pdf/epub/txt` | 导出小说文件 |

---

## 📚 详细使用教程

### 第一步：初始化小说

```
/小说 初始化 星辰之海
```
> ✅ 小说《星辰之海》已创建！

---

### 第二步：构建世界观

多次添加世界观设定：
```
/小说 设定 名称：星辰联邦
/小说 设定 描述：公元3000年，人类已殖民三个星系。跃迁引擎基于暗物质共振原理。
/小说 设定 规则：超光速航行需要跃迁引擎
```

> ✅ 每添加 5 次设定/人物/创意，AI 会**自动在后台整理世界观**，将散乱信息归类为结构化文档。

手动触发整理：
```
/小说 整理世界观
```
> 🔄 正在使用 AI 整理世界观...
> ✅ 世界观整理完成！
> 💾 旧版世界观已备份到 worldview_backup.json

删除某条不需要的设定：
```
/小说 删除设定 rules 魔法禁令
```

---

### 第三步：添加角色

```
/小说 添加人物 林远 25岁的星舰导航员，沉稳冷静，在压力下反而更加专注
/小说 添加人物 苏黎 联邦暗物质研究所首席科学家，28岁天才少女
```

> ⚠️ 同名角色会被自动拦截，提示使用修改命令。

修改角色设定：
```
/小说 修改人物 林远 25岁星舰导航员，沉稳冷静，拥有感知暗物质的异能
```
> ✅ 角色「林远」的设定已更新！

删除不需要的角色：
```
/小说 删除人物 林远
```

> 💡 AI 在写作场景时，如果引入了新角色，会自动识别并添加到人物库（含详细描述和背景信息）。

---

### 第四步：设置写作风格

```
/小说 添加风格 硬科幻
```
然后直接在群里发送示例文本（自动收集）：
```
星舰的跃迁引擎发出低沉的嗡鸣，量子态的涟漪从引擎核心向外扩散...
```
完成收集后：
```
/小说 完成风格
/小说 切换风格 硬科幻
```

---

### 第五步：提交创意

```
/小说 创意 林远在跃迁事故后获得了感知暗物质流动的能力，但每次使用都会剧烈头痛
```
> 💡 收到创意，正在进行 AI 评分...
> ✅ 评分通过（均分 86.3），正在冲突检测...
> ✅ 创意已采纳！

---

### 第六步：开始写作

```
/小说 新章节 觉醒
/小说 写 林远在跃迁事故后苏醒，苏黎发现他脑部出现异常暗物质共振波形
```
> 📝 正在生成场景...
> 📖 场景生成完成！

---

### 第七步：修正润色

**AI 自动修正**（三轮流水线）：
```
/小说 修正
```
> ✏️ 三轮修正：审读 → 修改 → 审校
> ✅ 修正完成！（v2）

**用户介入修正**（一次性描述）：
```
/小说 更改 1 主角的性格需要更强势一些，对话要更果断
```

**用户介入修正**（交互收集模式）：
```
/小说 更改 1 开始
```
> 📝 已进入第 1 章交互修正模式。

然后逐条发送修改意见：
```
第一段的环境描写不够紧张
苏黎的台词太生硬了
结尾需要一个悬念
```

收集完毕后提交：
```
/小说 结束更改
```
> ✏️ 已收集 3 条修改意见。正在提交给 AI 修正...

---

### 第八步：导出

```
/小说 导出 epub
```
> 📚 正在生成 EPUB...
> ✅ EPUB 导出完成！（文件自动发送到群聊）

```
/小说 导出 pdf
```
> 📄 正在生成 PDF...
> ✅ PDF 导出完成！（文件自动发送到群聊）

> 💡 导出的 PDF/EPUB 封面会自动显示参与创作群友的昵称（格式：`作者: xxx, xxx`）

---

### 重新开始

```
/小说 重置
```
> ✅ 已清空所有小说数据（知识库、创意、章节、投票）。
> 现在可以使用 /小说 初始化 <标题> 开始新故事！

---

## 🔄 AI 自动整理世界观

插件会在以下操作后累计计数，**每 5 次关键操作**自动触发 AI 整理世界观：
- 添加世界观设定
- 添加角色
- 创意被采纳
- 场景生成完成

AI 整理会：
1. 将散乱设定按类别归类（物理法则、社会制度、地理环境、历史、势力等）
2. 补充合理的细节（不与已有设定矛盾）
3. 标注设定之间的潜在矛盾
4. 整理前自动备份到 `worldview_backup.json`

你也可以随时手动触发：`/小说 整理世界观`

---

## 👥 贡献者追踪

插件会在以下操作时自动记录群友的 QQ 昵称：
- 提交创意（`/小说 创意`）
- 场景写作（`/小说 写`）
- 添加世界观设定（`/小说 设定`）
- 添加角色（`/小说 添加人物`）
- 修正章节（`/小说 更改` / `/小说 结束更改`）

贡献者列表存储在 `novel.json` 的 `contributors` 字段中，去重保存。导出 PDF / EPUB 时，封面作者栏自动显示为 `作者: 张三, 李四, 王五`。如无贡献者，回退到 `群体协作`。

---

## 🤖 分角色AI模型配置

不同的 AI 功能可以配置不同的模型，通过 WebUI 下拉选择已配好的模型商：

| 角色 | 配置项 | 推荐模型 |
|------|--------|----------|
| 创意评分 | `provider_idea_scoring` | 性价比模型即可 |
| 写作生成 | `provider_writing` | 推荐强力模型 |
| 修正审校 | `provider_revision` | 推荐强力模型 |
| 世界观整理 | `provider_worldview` | 性价比模型即可 |

留空则使用全局默认模型。优先从配置读取，不可用时自动回退到默认。

---

## 🔒 群隔离说明

- 每个群的小说数据**完全独立**，存储在 `groups/<群号>/` 子目录下
- 群 A 的操作不会影响群 B
- 每个群可以同时进行不同的小说创作
- 通过 `enabled_groups` 配置项控制哪些群可以使用插件

---

## 💡 使用技巧

1. **世界观越详细越好**：多次使用 `/小说 设定` 逐步补充，AI 会自动整理
2. **风格样本 3-5 段**：每段 100-300 字，涵盖叙事、对话、心理描写
3. **场景描述要具体**：描述越详细，AI 生成质量越高
4. **每写完就修正**：`/小说 修正` 会保留历史版本不丢失
5. **善用用户介入修正**：AI 修正不满意时，用 `/小说 更改` 提出具体意见让 AI 重改
6. **定期导出备份**：`/小说 导出 epub` 生成精美电子书
7. **分配AI模型**：写作使用强力模型，评分和整理使用便宜模型，兼顾质量和成本
8. **善用修改人物**：随时用 `/小说 修改人物` 完善角色设定，AI 写作时参考最新设定
9. **留意自动收录**：AI 写作时会自动提取新角色到人物库，写完后查看 `/小说 人物列表` 确认
10. **试试群聊小说**：发送 `/群聊小说 开始构建 <风格>` 即可自动把聊天记录变成小说

---

## 🗣️ 群聊小说详细说明

群聊小说是一个全新的独立功能——自动收集群聊消息，AI 以群友为人物原型创作小说。

### 快速开始

```
/群聊小说 开始构建 仙途纪事 轻松日常风格，充满欢笑和友情
```
> ✅ 群聊小说《仙途纪事》开始构建！
> 群友们正常聊天即可，AI 会将聊天内容转化为小说情节。

### 工作流程

1. 发送 `/群聊小说 开始构建 <书名> <风格/主题>` 开始收集
2. 群友正常聊天，插件被动收集每条消息
3. 累计 50 条消息后（可在配置中修改），AI 自动生成一章小说并在群里通知
4. AI 自动将群友映射为小说角色（名字风格相近）
5. 后续章节会参考前序章节内容和人物设定
6. 随时 `/群聊小说 停止` 结束收集
7. `/群聊小说 导出 pdf` 导出完整小说

### 常用指令示例

```
/群聊小说 状态              ← 查看进度
/群聊小说 修改名称 新书名    ← 修改小说名称
/群聊小说 删除              ← 删除本群所有数据（慎用）
/群聊小说 导出 epub          ← 导出全文
```

> 💡 群聊小说与 `/小说` 功能完全独立，各自的人物、章节、导出互不干扰。
> 可以在同一个群同时使用两套功能。

