"""
AI Prompt 模板模块 — 集中管理所有提示词
"""

# =====================================================================
# 创意打分
# =====================================================================
SCORE_IDEA_PROMPT = """\
你是一位资深的小说编辑和创意顾问。请对以下创意进行评分。

## 当前小说信息
- 标题：{novel_title}
- 梗概：{novel_synopsis}

## 当前世界观摘要
{worldview_summary}

## 已有创意（已采纳）
{existing_ideas}

## 待评分的创意
- 提交者：{author}
- 类型：{idea_type}
- 内容：{idea_content}

## 评分标准（每项 0-100 分）
1. **创意性**（originality）：创意是否新颖有趣，能为故事增色
2. **契合度**（coherence）：与已有世界观、人物、故事线的融合度
3. **叙事价值**（narrative_value）：对推动故事发展、丰富情节的贡献

请严格以 JSON 格式返回，不要有其他内容：
```json
{{
  "originality": <0-100>,
  "coherence": <0-100>,
  "narrative_value": <0-100>,
  "overall": <0-100>,
  "reason": "<一句话评价>"
}}
```
"""

# =====================================================================
# 冲突检测
# =====================================================================
CONFLICT_CHECK_PROMPT = """\
你是一位严谨的小说世界观审核员。请检查新提交的创意是否与已有设定存在冲突。

## 当前世界观
{worldview}

## 当前人物设定
{characters}

## 已采纳的创意
{approved_ideas}

## 新提交的创意
{new_idea}

请仔细分析是否存在以下类型的冲突：
1. **世界观冲突**：与已有物理法则、魔法体系、社会规则等设定矛盾
2. **人物冲突**：与角色性格、能力、背景不符
3. **情节冲突**：与已发生的事件、已确立的因果关系矛盾
4. **逻辑冲突**：存在内在逻辑矛盾

请严格以 JSON 格式返回：
```json
{{
  "has_conflict": true/false,
  "conflicts": [
    {{
      "type": "worldview/character/plot/logic",
      "description": "冲突描述",
      "existing_setting": "已有设定内容",
      "new_idea_part": "新创意冲突部分"
    }}
  ],
  "suggestion": "如果有冲突，给出折中方案；如果无冲突，说明为什么可以兼容"
}}
```
"""

# =====================================================================
# 场景生成
# =====================================================================
GENERATE_SCENE_PROMPT = """\
你是一位才华横溢的小说家。请根据以下信息创作一个精彩的小说场景。

## 小说信息
- 标题：{novel_title}
- 当前章节：{chapter_title}

## 前情摘要
{global_summary}

## 上一场景摘要
{previous_scene_summary}

## 本场景涉及的角色
{characters_info}

## 场景地点
{location_info}

## 本场景要融入的创意/要求
{scene_outline}

## 世界观要点
{worldview_context}

## 写作风格要求
{style_name}
### 风格说明
{style_guidelines}
### 风格参考样本
{style_samples}

## 重要约束
1. 字数要求：**至少** {max_length} 字，越详尽越好。务必写出充实丰富的内容，不要草草了事
2. 严格模仿上述写作风格
3. 保持与前情和世界观的一致性
4. 注意角色性格和说话方式的一致性
5. 场景要有起承转合，有画面感
6. 对话要自然，符合角色身份
7. 每个场景应包含充分的**环境描写**、**人物心理活动**、**对话互动**和**动作细节**
8. 情节展开要细腻完整，不要跳跃式叙述，要有层层递进的节奏
9. 适当加入感官描写（视觉、听觉、触觉、嗅觉等）增强沉浸感

请直接输出场景正文，不要加标题或额外说明。字数一定要充足，宁多勿少。
"""

# =====================================================================
# 多 AI 修正 — 第一轮：审读
# =====================================================================
REVISE_SCENE_PROMPT_PASS1 = """\
你是一位资深的文学编辑。请审读以下小说场景，指出需要改进的地方。

## 小说背景
- 标题：{novel_title}
- 当前风格：{style_name}

## 前情摘要
{global_summary}

## 当前场景
{scene_content}

## 涉及角色
{characters_info}

请从以下维度审读并给出具体修改建议：
1. **文笔质量**：语句是否通顺优美，是否有病句、冗余
2. **风格一致性**：是否符合 {style_name} 的风格
3. **角色一致性**：对话和行为是否符合角色设定
4. **情节连贯性**：与前情是否连贯，逻辑是否自洽
5. **画面感**：场景描写是否生动，是否有不足

请以 JSON 格式返回修改建议：
```json
{{
  "quality_score": <1-10>,
  "suggestions": [
    {{
      "type": "文笔/风格/角色/情节/画面",
      "location": "问题所在的原文引用",
      "issue": "问题描述",
      "fix": "修改建议"
    }}
  ],
  "overall_comment": "总体评价"
}}
```
"""

# =====================================================================
# 多 AI 修正 — 第二轮：执行修改
# =====================================================================
REVISE_SCENE_PROMPT_PASS2 = """\
你是一位出色的小说家。请根据编辑的修改建议，对场景进行润色修改。

## 原始场景
{scene_content}

## 编辑的修改建议
{revision_suggestions}

## 写作风格要求
{style_name}: {style_guidelines}

## 参考样本
{style_samples}

请按照修改建议对场景进行修改，注意：
1. 保留原文的优秀部分
2. 针对性地修改指出的问题
3. 保持整体风格一致
4. 确保修改后的文本自然流畅

请直接输出修改后的完整场景，不要加说明。
"""

# =====================================================================
# 多 AI 修正 — 第三轮：最终审校
# =====================================================================
REVISE_SCENE_PROMPT_PASS3 = """\
你是最终审校编辑。请对修改后的场景做最后检查。

## 修改后的场景
{revised_content}

## 原始场景（对比参考）
{original_content}

## 世界观要点
{worldview_context}

## 角色信息
{characters_info}

请检查：
1. 修改是否引入了新的问题
2. 文字是否通顺流畅
3. 是否与世界观和角色设定一致
4. 整体质量是否有提升

如果发现问题，请修正后输出；如果没有问题，直接输出修改后的版本即可。
请直接输出最终版本的场景正文，不要加说明。
"""

# =====================================================================
# 场景摘要
# =====================================================================
SUMMARIZE_SCENE_PROMPT = """\
请为以下小说场景写一段简洁的摘要（100字以内），概括关键情节、人物动态和重要转折。

## 场景内容
{scene_content}

请直接输出摘要，不要加标题或前缀。
"""

# =====================================================================
# 全局摘要更新
# =====================================================================
SUMMARIZE_GLOBAL_PROMPT = """\
你正在维护一部长篇小说的全局摘要。请根据旧摘要和新完成的场景，更新全局摘要。

## 旧的全局摘要
{old_summary}

## 新完成的场景摘要
{new_scene_summary}

请输出更新后的全局摘要（300字以内），要包含：
1. 故事主线进展
2. 关键角色的状态变化
3. 未解决的悬念和伏笔

请直接输出摘要，不要加标题或前缀。
"""

# =====================================================================
# 世界观整理完善
# =====================================================================
REFINE_WORLDVIEW_PROMPT = """\
你是一位专业的小说世界观架构师。请根据以下现有的世界观设定和最新的故事内容，整理并完善世界观文档。

## 当前世界观（原始数据）
{current_worldview}

## 当前人物设定
{characters}

## 最新采纳的创意
{recent_ideas}

## 最新故事进展
{story_progress}

请执行以下任务：
1. **整理归类**：将散乱的设定信息按类别整理（物理法则、社会制度、地理环境、历史事件、势力组织等）
2. **补充细节**：根据故事发展，推导并补充合理的细节设定（但不要与已有设定矛盾）
3. **标注矛盾**：如果发现已有设定之间存在潜在矛盾，在备注中指出
4. **提炼规则**：从已有内容中提炼出明确的世界观规则

请严格以 JSON 格式返回，结构如下：
```json
{{
  "name": "世界名称",
  "description": "世界观综合描述（200字以内）",
  "rules": ["规则1", "规则2", ...],
  "locations": [
    {{"name": "地名", "description": "描述", "connections": ["关联地点"]}}
  ],
  "history": [
    {{"era": "时代", "event": "事件", "impact": "影响"}}
  ],
  "factions": [
    {{"name": "势力名", "description": "描述", "members": ["人物名"]}}
  ],
  "custom": {{
    "additional_category": "补充的其他设定分类内容"
  }},
  "notes": "整理备注（矛盾提醒、补充建议等）"
}}
```
"""

# =====================================================================
# 用户介入修正章节
# =====================================================================
USER_GUIDED_REVISION_PROMPT = """\
你是一位专业的小说编辑。用户对当前章节的内容不满意，提供了修改指导意见。
请根据用户的反馈修改章节内容。

## 小说信息
- 标题：{novel_title}
- 当前风格：{style_name}

## 世界观概要
{worldview_context}

## 角色信息
{characters_info}

## 当前章节内容（第{chapter_number}章「{chapter_title}」）
{chapter_content}

## 用户的修改意见
{user_feedback}

## 修改要求
1. 准确理解用户的意图，按照要求修改
2. 如果用户描述了图片内容，将其合理融入文本
3. 保持与世界观和角色设定的一致性
4. 保持现有的写作风格和叙事节奏
5. 如果用户要求修改特定段落，只修改对应部分，其余保持不变
6. 如果用户要求修改整体方向，适当调整内容但保持已有的好部分

请直接输出修改后的完整章节内容（所有场景），不要加任何说明或标注。
"""

# =====================================================================
# 从场景中提取新角色
# =====================================================================
EXTRACT_NEW_CHARACTERS_PROMPT = """\
你是一位细心的小说编辑。请从以下刚生成的场景文本中，识别出**新出现的角色**（不包括已有角色列表中的）。

## 已有角色列表
{existing_characters}

## 刚生成的场景内容
{scene_content}

如果场景中出现了不在已有角色列表中的新角色（必须是有名字的角色，不包含"路人"、"某个人"等泛指），请返回他们的信息。
请尽量详细地描述每个新角色的特征和设定。

请严格以 JSON 格式返回：
```json
{{
  "new_characters": [
    {{
      "name": "角色名",
      "description": "根据场景内容推断的详细描述（包含身份、外貌特征、性格特点、行为方式、说话风格等，100字以内）",
      "background": "根据场景内容推断的背景信息（包含与其他角色的关系、在故事中的角色定位、已知经历等，100字以内）"
    }}
  ]
}}
```

如果没有新角色，返回空列表：
```json
{{"new_characters": []}}
```
"""


# =====================================================================
# 群聊小说 — 章节生成
# =====================================================================
CHAT_NOVEL_GENERATE_CHAPTER_PROMPT = """\
你是一位才华横溢的小说家。请根据以下群聊天记录，创作一章精彩的小说。

## 小说信息
- 标题：{novel_title}
- 当前章节号：第{chapter_number}章
- 风格/主题要求：{requirements}

## 故事进展摘要
{global_summary}

## 前序章节概要
{previous_chapters}

## 人物列表（群昵称 → 小说角色名）
{characters_info}

## 本章素材 — 群聊天记录
以下是群聊天的原始记录，请以此为灵感素材，将群友们的对话、互动、话题转化为小说情节。
注意：不要直接照搬聊天内容，而是**以此为基础创作**有趣的故事。

```
{chat_log}
```

## 新参与者（尚未分配角色名的群友）
{new_participants}

## 创作要求
1. 以群友为人物原型，使用他们的小说角色名进行创作
2. 内容字数请控制在 {max_word_count} 字左右，切勿过长导致内容被截断，但情节要相对充实
3. 保持与前序章节内容的连贯性
4. 包含充分的环境描写、人物心理活动、对话互动和动作细节
5. 对话要生动自然、符合角色性格
6. 适当加入感官描写增强沉浸感
7. 故事情节要有起承转合，不要流水账
8. 将群友的话题和互动巧妙融入情节
{ending_instruction}
## 输出格式
请以 JSON 格式返回：
```json
{{
  "chapter_title": "本章标题（简短有吸引力）",
  "content": "完整的章节正文内容",
  "summary": "本章内容摘要（200字以内）",
  "updated_summary": "更新后的整体故事进展摘要（300字以内）",
  "character_updates": [
    {{
      "real_name": "群昵称",
      "novel_name": "小说角色名",
      "description": "角色在本章中的新特征或发展"
    }}
  ]
}}
```
"""

# =====================================================================
# 群聊小说 — 角色映射
# =====================================================================
CHAT_NOVEL_MAP_CHARACTERS_PROMPT = """\
你是一位善于角色设计的小说家。请为以下群聊参与者创建小说中的角色形象。

## 新参与者的群聊昵称
{new_participants}

## 已有角色（避免重名或风格冲突）
{existing_characters}

## 小说风格/主题要求
{requirements}

## 创作要求
1. 为每个参与者起一个与其群昵称**风格相近或谐音**的小说角色名
2. 角色名要自然，符合小说世界观
3. 为每个角色设计有辨识度的性格特点和外貌描述

## 输出格式
请以 JSON 格式返回：
```json
{{
  "characters": [
    {{
      "real_name": "群昵称（原样）",
      "novel_name": "小说中的角色名",
      "description": "角色外貌、性格、特点等描述（100字以内）"
    }}
  ]
}}
```
"""


# =====================================================================
# 群聊小说 — 消息质量评估
# =====================================================================
CHAT_NOVEL_EVALUATE_QUALITY_PROMPT = """\
你是一位经验丰富的编辑。请评估以下群聊消息是否包含足够的**有意义的内容**，可以作为素材创作一章小说。

## 群聊消息（共{message_count}条）
```
{chat_log}
```

## 评判标准
- 有效内容包括：真实对话、话题讨论、事件描述、情感表达、互动交流
- 无效内容包括：纯表情包/贴纸、单字回复（如"哦""嗯"）、无意义水群、重复刷屏、机器人指令
- 如果有效消息占比超过 {quality_threshold}%，且涉及至少一个可转化为情节的话题或事件，则判定为**充足**

请以 JSON 格式返回：
```json
{{
  "sufficient": true或false,
  "valid_ratio": "有效消息占比（如 65%）",
  "reason": "简要说明理由（30字以内）"
}}
```
"""

# =====================================================================
# 封面图片生成 — 提示词组装
# =====================================================================

# =====================================================================
# 群聊小说 — 消息过滤（小模型）
# =====================================================================
CHAT_NOVEL_FILTER_MESSAGES_PROMPT = """\
你是一位高效的消息筛选助手。请从以下群聊消息列表中，筛选出**有意义的消息**，去掉无用信息。

## 群聊消息（共{message_count}条）
每条消息格式为 [序号] [发送者]: 内容
```
{chat_log}
```

## 筛选标准
- **保留**：真实对话、话题讨论、事件描述、情感表达、观点交流、叙事内容、有趣的互动
- **去掉**：纯表情包/贴纸、单字回复（如"哦""嗯""啊"）、无意义水群消息、重复刷屏、机器人指令/回复、纯数字、纯符号

请返回需要**保留**的消息序号列表（从0开始）。
请严格以 JSON 格式返回：
```json
{{
  "keep_indices": [0, 2, 5, 7, ...]
}}
```
"""



# =====================================================================
# 群聊小说 — 角色关系图
# =====================================================================
CHAT_NOVEL_RELATIONSHIP_PROMPT = """\
你是一位善于分析人物关系的文学评论家。请根据以下小说内容，分析角色之间的关系。

## 角色列表
{characters_info}

## 章节内容摘要
{chapters_summary}

## 分析要求
分析所有角色之间的关系，生成 Mermaid 图表代码。

规则：
1. 代码第一行必须是 `graph LR`（不要加 init 指令，系统会自动注入主题）
2. 每个节点标签必须同时显示小说名和群昵称，格式为 `A["小说名<br/>(群昵称)"]`，用 `<br/>` 换行、群昵称加圆括号
3. 边的标签用 `|关系描述|` 描述关系（如：好友、对手、暧昧、师徒、宿敌等）
4. 用不同的箭头样式表示关系类型：`-->` 单向关系，`---` 双向关系, `-.->` 暧昧/不确定关系
5. 在代码最后添加 linkStyle 和 classDef 让线条更粗更明显，例如：
   `linkStyle default stroke:#333,stroke-width:2px`
6. 请不要在标签中使用单引号或反引号等特殊字符，双引号包裹节点标签即可
7. 每个角色至少要有一个关系连接

## 示例
```
graph LR
    A["逸风<br/>(小明)"] -->|好友| B["星辰<br/>(大壮)"]
    B ---|对手| C["月华<br/>(小红)"]
    A -.->|暧昧| C
    linkStyle default stroke:#333,stroke-width:2px
```

请严格以 JSON 格式返回：
```json
{{
  "mermaid_code": "graph LR\\n    A[\\"逸风<br/>(小明)\\"] -->|好友| B[\\"星辰<br/>(大壮)\\"]\\n    linkStyle default stroke:#333,stroke-width:2px",
  "description": "关系图的文字概述（100字以内）"
}}
```
"""

# =====================================================================
# 群聊小说 — 章节重写
# =====================================================================
CHAT_NOVEL_REWRITE_CHAPTER_PROMPT = """\
你是一位才华横溢的小说家。请根据用户的补充说明，重新创作指定章节。

## 小说信息
- 标题：{novel_title}
- 当前章节号：第{chapter_number}章
- 风格/主题要求：{requirements}

## 故事进展摘要
{global_summary}

## 前序章节概要
{previous_chapters}

## 后续章节概要（如有）
{next_chapters}

## 人物列表
{characters_info}

## 原章节内容
```
{original_content}
```

## 用户的补充说明/修改要求
{user_instructions}

## 创作要求
1. 根据用户的补充说明重新创作本章内容
2. 保持与前后章节的连贯性
3. 内容字数请控制在 {max_word_count} 字左右
4. 保留原章节中好的部分，改进不满意的部分
5. 对话要生动自然、符合角色性格
6. 故事情节要有起承转合

## 输出格式
请以 JSON 格式返回：
```json
{{
  "chapter_title": "重写后的章节标题",
  "content": "完整的重写后章节正文",
  "summary": "本章内容摘要（200字以内）"
}}
```
"""

COVER_IMAGE_PROMPT_TEMPLATE = """\
{user_prompt}

小说名称：《{title}》
剧情简介：{synopsis}

要求：
1. 生成一张竖版小说封面（宽高比约 2:3），构图完整、画面精致
2. 封面上方或居中位置用醒目的艺术字体清晰显示标题「{title}」
3. 背景画面应紧扣剧情简介所描述的世界观与核心氛围
4. 可包含与故事相关的代表性角色剪影或关键意象元素
5. 整体色调协调统一，具有专业出版物的视觉水准
"""
